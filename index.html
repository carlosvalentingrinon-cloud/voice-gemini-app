<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Gemini Voice PRO</title>
<style>
body { font-family: Arial; background:#111; color:white; padding:20px; }
textarea { width:100%; height:120px; font-size:16px; padding:10px; border-radius:8px; border:none; resize:none; }
button { margin-top:10px; padding:10px 20px; border-radius:8px; border:none; cursor:pointer; font-size:16px; margin-right:10px; }
#micBtn { background:#ff4d4d; color:white; }
#sendBtn { background:#4CAF50; color:white; }
#wave { display:flex; margin-top:15px; height:40px; align-items:flex-end; gap:2px; }
.bar { width:6px; background:#00ffcc; }
#status { margin-top:10px; color:#aaa; }
#response { margin-top:20px; background:#222; padding:15px; border-radius:8px; white-space:pre-wrap; }
</style>
</head>
<body>

<h2> Gemini Voice PRO</h2>
<textarea id="prompt" placeholder="Tu transcripci贸n aparecer谩 aqu铆..."></textarea>
<br>
<button id="micBtn"> Grabar voz</button>
<button id="sendBtn">Enviar a Gemini</button>

<div id="wave">
  <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
</div>

<div id="status"></div>
<div id="response"></div>

<script>
let mediaRecorder, audioChunks = [], isRecording = false;
const bars = document.querySelectorAll(".bar");
let audioContext, analyser, dataArray;

// Configurar ondas
function setupAudioAnalyser(stream) {
  audioContext = new AudioContext();
  analyser = audioContext.createAnalyser();
  const source = audioContext.createMediaStreamSource(stream);
  source.connect(analyser);
  analyser.fftSize = 32;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  animateWave();
}

function animateWave() {
  if (!isRecording) return;
  analyser.getByteFrequencyData(dataArray);
  bars.forEach((bar, i) => {
    bar.style.height = (10 + dataArray[i]*0.5) + "px";
  });
  requestAnimationFrame(animateWave);
}

// Bot贸n grabar
document.getElementById("micBtn").addEventListener("click", async () => {
  if (!isRecording) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    setupAudioAnalyser(stream);
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();
    isRecording = true;
    document.getElementById("status").innerText = "Grabando...";
    document.getElementById("wave").style.display = "flex";
  } else {
    mediaRecorder.stop();
    isRecording = false;
    document.getElementById("status").innerText = "Grabaci贸n detenida";
    document.getElementById("wave").style.display = "none";
    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      const reader = new FileReader();
      reader.readAsDataURL(blob);
      reader.onloadend = () => {
        window.base64Audio = reader.result.split(',')[1];
        document.getElementById("prompt").value = "Audio listo para enviar";
      }
    }
  }
});

// Bot贸n enviar a Gemini
document.getElementById("sendBtn").addEventListener("click", () => {
  if (!window.base64Audio) { document.getElementById("status").innerText="Graba algo primero."; return; }
  document.getElementById("status").innerText="Procesando audio...";
  document.getElementById("response").innerText="";

  google.script.run
    .withSuccessHandler(res => {
      document.getElementById("response").innerText = res;
      document.getElementById("status").innerText="Respuesta recibida";
    })
    .withFailureHandler(err => {
      document.getElementById("response").innerText = "Error: " + err.message;
      document.getElementById("status").innerText="Error";
    })
    .processAudio(window.base64Audio);
});
</script>

</body>
</html>
